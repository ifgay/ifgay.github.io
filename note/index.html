<!DOCTYPE html>
<html lang="zh_cn">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ifgay|笔记</title>
	<link rel="stylesheet" href="../src/darcula.css">
	<link rel="stylesheet" href="./doc.css">
	<script src="../src/jq.min.js"></script>
	<script src="../src/heighlight.mini.js"></script>
	<script src="../src/marked.min.js"></script>
	<script src="../src/jquery.mark.js"></script>
</head>

<body>
	<section class="header flex_between">
		<span>
			say,hello!
		</span>
		<span>
			<a href="https://github.com/amdog">
				<img src="../src/git.svg">
			</a>
		</span>
	</section>


	

	<ul class="list">
		<br><small class='txt_center flex_center' style=" letter-spacing: 5px;">--最近创建文档--</small><hr><br>
		<li class='recent'>
			<div class="process_out" style="margin: 0 auto;">
				<span class="proce_say">
					探测最近文档中(<span class="poce_tage"></span>)...
				</span>
				<div class="process_in">
					
				</div>
			</div>
		</li>
		<div class="loading txt_center lastli"></div>
	</ul>
	<section class="footer flex_center">
		<input type="text" class="search_input" placeholder="输入关键字...">
	</section>

	<div class="top_box">
		^
	</div>

</body>
<script>


function mainInit(isDev){
	function showStrAnimaPreten() {
			let strPac = ['/', '\\', '-']
			let strPoi = ['.', '..', '...']
			let nowPrec = 14
			let _clock
			return function () {
				clearInterval(_clock)
				_clock = setInterval(() => {
					nowPrec++
					$('.loading').html(
						`<span>${strPac[nowPrec%3]}</span><span>${strPoi[nowPrec%3]}</span>`)
				}, 600)
			}
		}
		let showStrAnima = showStrAnimaPreten()()
		let index = 0
		let couldLoad = true
		let isLock = false
		let version=parseInt(Math.random()*10000)
		let recentPage=''

		;(function loadRecentPage(indexRecent){
			$.ajax({
				method: 'get',
				url: `./md/${indexRecent}.md?version=${version}`,
				success: (md) => {
					recentPage=md
					$('.process_in').css('width',`${indexRecent*2}%`)
					if(indexRecent<=99) $('.poce_tage').text(`${indexRecent}%`)
					loadRecentPage(++indexRecent)
				},
				error: () => {
					$('.process_in').css('width','100%')
					$('.poce_tage').text('100%')
					setTimeout(()=>{
						$('.recent').html(marked.marked(recentPage))
						hljs.highlightAll();
						markAction()
					},200)
				}
			})
		}(1))


		function loadByAjax(index, callback) {
			isLock = true
			$.ajax({
				method: 'get',
				url: `./md/${index}.md?version=${version}`,
				success: (res) => {
					isLock = false
					callback(res)
				},
				error: () => {
					isLock = false
					callback(false)
				}
			})

		}

		function render(md) {
			setTimeout(() => {
				$('.loading').hide()
				let listEle = $('.list')
				if (!md) {
					couldLoad = false;
					return listEle.append(`<p class='txt_center'><br><br>已经加载全部...<br><br></p>`)
				}
				$('.lastli').before(`<br><small class='txt_center flex_center' style=" letter-spacing: 5px;">第${index}页</small><hr><br><li class='page'>${marked.marked(md)}</li>`)
				hljs.highlightAll();
				markAction()
			}, 400)
		}

		function tholePreten() {
			let clock = setTimeout(() => {
				index++
				if (isLock) return
				loadByAjax(index, render)
			}, 600)
			return function () {
				$('.loading').show()
				clearTimeout(clock)
				if (isLock) return
				clock = setTimeout(() => {
					index++
					loadByAjax(index, render)
				}, 600)
			}
		}

		let thole = tholePreten()


		$('.list').scroll(function () {
			let scrollTop = $(this).scrollTop();
			let scrollHeight = $(document).height();
			let windowHeight = $(this).height();
			if(scrollTop>=20) $('.top_box').fadeIn()
			if(scrollTop<20) $('.top_box').fadeOut()
			if ((scrollTop + windowHeight) >= (scrollHeight - 170)) {
				if (couldLoad) thole()
				return
			}
		});
		$('.top_box').click(()=>{
			$('.list').scrollTop(0)
		})
}


	$(function () {
		$.ajax({
			url:'/dev.env',
			success:()=>{
				mainInit(true)
			},
			error:()=>{
				mainInit(false)
			}
		})
	});

	function tholeSearch() {
		let clockInput = setTimeout(() => {
			markAction()
		}, 500)
		return function () {
			clearTimeout(clockInput)
			clockInput = setTimeout(() => {
				markAction()
			}, 500)
		}
	}

	function markAction() {
		$(".list").removeMark();
		$(".list").mark($('.search_input').val(), {
			complete:(ele)=>{
				
			}
		});
	}


	$('.search_input').on('keyup',tholeSearch())
</script>

</html>